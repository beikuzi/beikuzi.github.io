const qs=e=>document.querySelector(e);const qsa=e=>document.querySelectorAll(e);
let live2dLoaded=false;let live2dEnabled=false;let bubblesCanvas=null;let bubblesCtx=null;let bubblesTimer=null;let resizeBubbles=null;let ribbonCanvas=null;let ribbonCtx=null;let ribbonTimer=null;let resizeRibbon=null;let sakuraCanvas=null;let sakuraCtx=null;let sakuraTimer=null;let resizeSakura=null;let trailCanvas=null;let trailCtx=null;let trailTimer=null;let onMoveTrail=null;let resizeTrail=null;let starCanvas=null;let starCtx=null;let starTimer=null;let resizeStar=null;let onMoveStar=null;let starLastAt=0;let rippleCanvas=null;let rippleCtx=null;let rippleTimer=null;let resizeRipple=null;let onClickRipple=null;let burstCanvas=null;let burstCtx=null;let burstTimer=null;let resizeBurst=null;let onClickBurst=null;let currentEffect='none';let resizeStartX=null;let resizeStartWidth=null;let onResizeMove=null;let onResizeUp=null;
let starCfg={spawnIntervalMs:40,spawnCount:2,initialAlpha:.95,alphaDecay:.96,radiusMin:4,radiusMax:7,radiusDecay:.995,minAlphaThreshold:.04,minRadiusThreshold:1.2,velocityRange:.6,zIndex:10000};
let rippleCfg={maxRadius:160,growSpeed:3,lineWidth:4,alphaStart:1,alphaDecay:0.965,lineWidthDecay:0.995,zIndex:9999};
let gridCfg={minRatio:0.10,maxRatio:0.20,gapPx:36,minCols:1,maxCols:8};
let bgAudio=null;let playMode='loop';
let playlist=[];let playlistIndex=0;let playlistMode=false;let musicLoaded=false;
const openAll=()=>{qsa('.cat').forEach(c=>c.classList.add('open'))};
const closeAll=()=>{qsa('.cat').forEach(c=>c.classList.remove('open'))};
const toggleCat=e=>{e.currentTarget.closest('.cat').classList.toggle('open')};
const loadScript=(src)=>new Promise((res,rej)=>{if(document.querySelector(`script[src="${src}"]`))return res();const s=document.createElement('script');s.src=src;s.onload=res;s.onerror=rej;document.head.appendChild(s)});

const enableGradient=()=>{if(document.querySelector('.bg-anim'))return;const d=document.createElement('div');d.className='bg-anim';document.body.appendChild(d)};
const disableGradient=()=>{const d=document.querySelector('.bg-anim');if(d)d.remove()};
const enableBubbles=()=>{if(bubblesCanvas)return;bubblesCanvas=document.createElement('canvas');bubblesCanvas.className='bg-bubbles';bubblesCanvas.style.cssText='position:fixed;left:0;top:0;width:100%;height:100%;z-index:-1;pointer-events:none';document.body.appendChild(bubblesCanvas);resizeBubbles=()=>{bubblesCanvas.width=window.innerWidth;bubblesCanvas.height=window.innerHeight};resizeBubbles();window.addEventListener('resize',resizeBubbles);bubblesCtx=bubblesCanvas.getContext('2d');const bubbles=[];const spawn=()=>({x:Math.random()*bubblesCanvas.width,y:bubblesCanvas.height+10,r:3+Math.random()*8,vy:-0.6-Math.random()*1.6,alpha:.35+.55*Math.random(),h:Math.random()*360});for(let i=0;i<80;i++)bubbles.push(spawn());const draw=()=>{bubblesCtx.clearRect(0,0,bubblesCanvas.width,bubblesCanvas.height);for(const b of bubbles){b.y+=b.vy;if(b.y<-20){b.x=Math.random()*bubblesCanvas.width;b.y=bubblesCanvas.height+10;b.r=3+Math.random()*8;b.vy=-0.6-Math.random()*1.6;b.alpha=.35+.55*Math.random();b.h=Math.random()*360}bubblesCtx.beginPath();bubblesCtx.arc(b.x,b.y,b.r,0,Math.PI*2);bubblesCtx.fillStyle=`hsla(${b.h},80%,70%,${b.alpha})`;bubblesCtx.fill()}bubblesTimer=requestAnimationFrame(draw)};draw()};
const disableBubbles=()=>{if(bubblesTimer)cancelAnimationFrame(bubblesTimer);bubblesTimer=null;if(resizeBubbles)window.removeEventListener('resize',resizeBubbles);resizeBubbles=null;if(bubblesCanvas){bubblesCanvas.remove();bubblesCanvas=null;bubblesCtx=null}};
const enableRibbon=()=>{if(ribbonCanvas)return;ribbonCanvas=document.createElement('canvas');ribbonCanvas.style.cssText='position:fixed;left:0;top:0;width:100%;height:100%;z-index:-1;pointer-events:none';document.body.appendChild(ribbonCanvas);resizeRibbon=()=>{ribbonCanvas.width=window.innerWidth;ribbonCanvas.height=window.innerHeight};resizeRibbon();window.addEventListener('resize',resizeRibbon);ribbonCtx=ribbonCanvas.getContext('2d');const ribbons=[];const make=()=>({y:Math.random()*ribbonCanvas.height,spd:0.6+Math.random()*1.2,h:Math.random()*360});for(let i=0;i<10;i++)ribbons.push(make());const draw=()=>{ribbonCtx.clearRect(0,0,ribbonCanvas.width,ribbonCanvas.height);ribbons.forEach(r=>{const w=ribbonCanvas.width;const path=new Path2D();const a=0;const b=w*0.33;const c=w*0.66;const d=w;const amp=60;const t=Date.now()*0.0005;const y=r.y+Math.sin(t+r.h)*amp;path.moveTo(a,y);path.bezierCurveTo(b,y-amp,c,y+amp,d,y);const grad=ribbonCtx.createLinearGradient(0,y,d,y);grad.addColorStop(0,`hsla(${r.h},80%,70%,0)`);grad.addColorStop(0.5,`hsla(${r.h},90%,70%,.8)`);grad.addColorStop(1,`hsla(${(r.h+40)%360},80%,70%,0)`);ribbonCtx.lineWidth=28;ribbonCtx.strokeStyle=grad;ribbonCtx.stroke();r.y+=Math.sin(t)*r.spd;if(r.y<-80)r.y=ribbonCanvas.height+80;if(r.y>ribbonCanvas.height+80)r.y=-80;r.h+=0.25});ribbonTimer=requestAnimationFrame(draw)};draw()};
const disableRibbon=()=>{if(ribbonTimer)cancelAnimationFrame(ribbonTimer);ribbonTimer=null;if(resizeRibbon)window.removeEventListener('resize',resizeRibbon);resizeRibbon=null;if(ribbonCanvas){ribbonCanvas.remove();ribbonCanvas=null;ribbonCtx=null}};
const enableSakura=()=>{if(sakuraCanvas)return;sakuraCanvas=document.createElement('canvas');sakuraCanvas.style.cssText='position:fixed;left:0;top:0;width:100%;height:100%;z-index:-1;pointer-events:none';document.body.appendChild(sakuraCanvas);resizeSakura=()=>{sakuraCanvas.width=window.innerWidth;sakuraCanvas.height=window.innerHeight};resizeSakura();window.addEventListener('resize',resizeSakura);sakuraCtx=sakuraCanvas.getContext('2d');const petals=[];const make=()=>({x:Math.random()*sakuraCanvas.width,y:-20-Math.random()*sakuraCanvas.height,r:8+Math.random()*10,vy:0.8+Math.random()*1.2,vx:-0.4+Math.random()*0.8,rot:Math.random()*Math.PI,vr:(Math.random()-0.5)*0.01,h:330+Math.random()*20});for(let i=0;i<60;i++)petals.push(make());const drawPetal=(ctx,p)=>{ctx.save();ctx.translate(p.x,p.y);ctx.rotate(p.rot);ctx.scale(1,0.6);ctx.beginPath();ctx.moveTo(0,0);ctx.quadraticCurveTo(-p.r*0.8,-p.r,p.r*0.2,-p.r*0.6);ctx.quadraticCurveTo(p.r*0.8,-p.r*0.2,0,p.r);ctx.closePath();ctx.fillStyle=`hsla(${p.h},80%,85%,0.85)`;ctx.shadowColor=`hsla(${p.h},80%,60%,0.25)`;ctx.shadowBlur=6;ctx.fill();ctx.restore()};const draw=()=>{sakuraCtx.clearRect(0,0,sakuraCanvas.width,sakuraCanvas.height);for(const p of petals){p.x+=p.vx;p.y+=p.vy;p.rot+=p.vr;if(p.y>sakuraCanvas.height+30){p.x=Math.random()*sakuraCanvas.width;p.y=-30;p.vy=0.8+Math.random()*1.2;p.vx=-0.4+Math.random()*0.8;p.r=8+Math.random()*10;p.rot=Math.random()*Math.PI}drawPetal(sakuraCtx,p)}sakuraTimer=requestAnimationFrame(draw)};draw()};
const disableSakura=()=>{if(sakuraTimer)cancelAnimationFrame(sakuraTimer);sakuraTimer=null;if(resizeSakura)window.removeEventListener('resize',resizeSakura);resizeSakura=null;if(sakuraCanvas){sakuraCanvas.remove();sakuraCanvas=null;sakuraCtx=null}};
const enableLive2D=async()=>{if(live2dEnabled)return;await loadScript('https://unpkg.com/live2d-widget@3.1.4/lib/L2Dwidget.min.js');L2Dwidget.init({model:{jsonPath:'https://unpkg.com/live2d-widget-model-miku/assets/miku.model.json'},display:{position:'right',width:160,height:300},mobile:{show:true},react:{opacityDefault:.9,opacityOnHover:1}});live2dLoaded=true;live2dEnabled=true};
const disableLive2D=()=>{live2dEnabled=false;const c1=document.getElementById('live2dcanvas');if(c1)c1.remove();const c2=document.querySelector('canvas.live2d');if(c2)c2.remove();};
const setEffect=v=>{if(currentEffect==='bubbles')disableBubbles();if(currentEffect==='ribbon')disableRibbon();if(currentEffect==='sakura')disableSakura();if(currentEffect==='clickBurst')disableClickBurst();currentEffect=v;if(v==='none')return;if(v==='bubbles')enableBubbles();if(v==='ribbon')enableRibbon();if(v==='sakura')enableSakura();if(v==='clickBurst')enableClickBurst()};
const setSidebarWidth=v=>{const val=typeof v==='number'?`${v}px`:v;document.documentElement.style.setProperty('--sidebar-width',val);try{localStorage.setItem('sidebarWidth',val)}catch(e){}};
const loadConfig=async()=>{try{const res=await fetch('/config.json',{cache:'no-store'});if(!res.ok)return;const cfg=await res.json();if(cfg.sidebarWidth)setSidebarWidth(cfg.sidebarWidth);if(cfg.defaultEffect){const allowed=['none','bubbles','ribbon','sakura','clickBurst'];const v=allowed.includes(cfg.defaultEffect)?cfg.defaultEffect:'none';const sel=qs('#effect-select');if(sel){sel.value=v;setEffect(v)}}if(cfg.darkModeDefault){document.body.classList.add('dark');const s=qs('#dark-theme-select');const dv=(cfg.darkThemeVariant)||localStorage.getItem('darkThemeVariant')||'soft';if(s)s.value=dv;document.body.classList.remove('dark-theme-soft','dark-theme-forest','dark-theme-violet');if(dv==='soft')document.body.classList.add('dark-theme-soft');if(dv==='forest')document.body.classList.add('dark-theme-forest');if(dv==='violet')document.body.classList.add('dark-theme-violet')}if(cfg.live2dDefault){const l=qs('#toggle-live2d');if(l){l.checked=true;enableLive2D()}}if(cfg.starTrail){const c=cfg.starTrail;if(typeof c.spawnIntervalMs==='number')starCfg.spawnIntervalMs=c.spawnIntervalMs;if(typeof c.spawnCount==='number')starCfg.spawnCount=c.spawnCount;if(typeof c.initialAlpha==='number')starCfg.initialAlpha=c.initialAlpha;if(typeof c.alphaDecay==='number')starCfg.alphaDecay=c.alphaDecay;if(typeof c.radiusMin==='number')starCfg.radiusMin=c.radiusMin;if(typeof c.radiusMax==='number')starCfg.radiusMax=c.radiusMax;if(typeof c.radiusDecay==='number')starCfg.radiusDecay=c.radiusDecay;if(typeof c.minAlphaThreshold==='number')starCfg.minAlphaThreshold=c.minAlphaThreshold;if(typeof c.minRadiusThreshold==='number')starCfg.minRadiusThreshold=c.minRadiusThreshold;if(typeof c.velocityRange==='number')starCfg.velocityRange=c.velocityRange;if(typeof c.zIndex==='number')starCfg.zIndex=c.zIndex}if(cfg.clickRipple){const r=cfg.clickRipple;if(typeof r.maxRadius==='number')rippleCfg.maxRadius=r.maxRadius;if(typeof r.growSpeed==='number')rippleCfg.growSpeed=r.growSpeed;if(typeof r.lineWidth==='number')rippleCfg.lineWidth=r.lineWidth;if(typeof r.alphaStart==='number')rippleCfg.alphaStart=r.alphaStart;if(typeof r.alphaDecay==='number')rippleCfg.alphaDecay=r.alphaDecay;if(typeof r.lineWidthDecay==='number')rippleCfg.lineWidthDecay=r.lineWidthDecay;if(typeof r.zIndex==='number')rippleCfg.zIndex=r.zIndex}if(cfg.grid){const g=cfg.grid;if(typeof g.minGapRatio==='number')gridCfg.minRatio=g.minGapRatio;if(typeof g.maxGapRatio==='number')gridCfg.maxRatio=g.maxGapRatio;if(typeof g.gapPx==='number'){gridCfg.gapPx=g.gapPx;document.documentElement.style.setProperty('--grid-gap',`${g.gapPx}px`)}if(typeof g.minCols==='number')gridCfg.minCols=g.minCols;if(typeof g.maxCols==='number')gridCfg.maxCols=g.maxCols}if(cfg.musicPop){const m=cfg.musicPop;if(m.width)document.documentElement.style.setProperty('--music-pop-width',typeof m.width==='number'?`${m.width}px`:m.width);if(typeof m.visibleRows==='number')document.documentElement.style.setProperty('--music-pop-visible-rows',String(m.visibleRows));if(typeof m.itemHeight==='number')document.documentElement.style.setProperty('--music-item-height',`${m.itemHeight}px`)}if(cfg.musicUI){const u=cfg.musicUI;if(typeof u.ctrlHeight==='number')document.documentElement.style.setProperty('--music-ctrl-height',`${u.ctrlHeight}px`);if(typeof u.ctrlGap==='number')document.documentElement.style.setProperty('--music-ctrl-gap',`${u.ctrlGap}px`);if(typeof u.progressHeight==='number')document.documentElement.style.setProperty('--music-progress-height',`${u.progressHeight}px`)}if(cfg.guide){const g=cfg.guide;if(typeof g.arrowWidth==='number')document.documentElement.style.setProperty('--guide-arrow-width',`${g.arrowWidth}px`);if(typeof g.arrowHeight==='number')document.documentElement.style.setProperty('--guide-arrow-height',`${g.arrowHeight}px`);if(typeof g.arrowThickness==='number')document.documentElement.style.setProperty('--guide-arrow-thickness',`${g.arrowThickness}px`);if(typeof g.arrowGap==='number')document.documentElement.style.setProperty('--guide-arrow-gap',`${g.arrowGap}px`)}}catch(e){}};
const init=()=>{qsa('.cat-toggle').forEach(b=>b.addEventListener('click',toggleCat));const collapseBtn=qs('.collapse-all');if(collapseBtn){collapseBtn.addEventListener('click',e=>{const allOpen=[...qsa('.cat')].every(x=>x.classList.contains('open'));if(allOpen)closeAll();else openAll()})}
const toggleDark=qs('.toggle-dark');const toggleLive2D=qs('#toggle-live2d');const effectSelect=qs('#effect-select');const btnThemeSelect=qs('#btn-theme-select');const sidebar=qs('.sidebar');const sidebarBtn=qs('.toggle-sidebar');const mask=qs('.mask');const resizer=qs('.sidebar-resizer');const edgeBtn=qs('.sidebar-edge');const content=qs('.content');const cards=[...qsa('.card')];const musicBtn=qs('.music-btn');const musicPop=qs('#music-pop');const playBtn=qs('.mc-play');const modeLoopBtn=qs('.mc-mode-loop');const modeOneBtn=qs('.mc-mode-one');const modeShuffleBtn=qs('.mc-mode-shuffle');const focusBtn=qs('.mc-focus');const prevBtn=qs('.mc-prev');const nextBtn=qs('.mc-next');const progress=qs('.mc-progress');const volBtn=qs('.mc-volume');const volPop=qs('.mc-volume-pop');const volSlider=qs('.mc-vol-vert');const volText=qs('.mc-vol-text');const musicCollapseBtn=qs('.mc-collapse');
let currentCardEffect='none';let tiltMove=null;let tiltEnter=null;let tiltLeave=null;const clearTilt=()=>{if(!cards.length)return;cards.forEach(c=>{if(tiltMove)c.removeEventListener('mousemove',tiltMove);if(tiltEnter)c.removeEventListener('mouseenter',tiltEnter);if(tiltLeave)c.removeEventListener('mouseleave',tiltLeave);c.style.transform='';c.style.transition=''})};const setCardHover=v=>{clearTilt();content.classList.remove('card-effect-none','card-effect-lift','card-effect-zoom','card-effect-glow','card-effect-tilt');currentCardEffect=v;content.classList.add(`card-effect-${v}`);if(v==='tilt'){tiltEnter=e=>{e.currentTarget.style.transition='transform 0.06s linear'};tiltMove=e=>{const r=e.currentTarget.getBoundingClientRect();const x=(e.clientX-r.left)/r.width;const y=(e.clientY-r.top)/r.height;const rx=(0.5-y)*8;const ry=(x-0.5)*10;e.currentTarget.style.transform=`rotateX(${rx}deg) rotateY(${ry}deg)`};tiltLeave=e=>{e.currentTarget.style.transition='transform .25s ease';e.currentTarget.style.transform=''};cards.forEach(c=>{c.addEventListener('mouseenter',tiltEnter);c.addEventListener('mousemove',tiltMove);c.addEventListener('mouseleave',tiltLeave)})}};
const sidebarHeader=qs('.sidebar-header');const updateEdgePosition=()=>{if(!edgeBtn||!sidebar)return;const isOpen=sidebar.classList.contains('open');if(sidebarHeader){const r=sidebarHeader.getBoundingClientRect();edgeBtn.style.top=`${r.top + r.height/2 - 24}px`;}if(isOpen){const s=sidebar.getBoundingClientRect();edgeBtn.style.left=`${s.right - 6}px`;edgeBtn.textContent='â€¹'}else{edgeBtn.style.left='0px';edgeBtn.textContent='â€º'}};
if(toggleDark){toggleDark.addEventListener('click',()=>{const on=!document.body.classList.contains('dark');document.body.classList.toggle('dark',on);document.body.classList.remove('dark-theme-soft','dark-theme-forest','dark-theme-violet');if(on){document.body.classList.add('dark-theme-forest')}})}
document.addEventListener('DOMContentLoaded',()=>{if(document.body.classList.contains('dark')){document.body.classList.remove('dark-theme-soft','dark-theme-violet');document.body.classList.add('dark-theme-forest')}});
if(toggleLive2D){toggleLive2D.addEventListener('change',e=>{if(e.target.checked)enableLive2D();else disableLive2D()})}
if(sidebarBtn){sidebarBtn.addEventListener('click',()=>{
  sidebar.classList.toggle('open');
  const isMobile=window.innerWidth<=1024;
  if(mask) mask.classList.toggle('show', isMobile && sidebar.classList.contains('open'));
  if(!sidebar.classList.contains('open') && mask) mask.classList.remove('show');
  if(edgeBtn) edgeBtn.textContent=sidebar.classList.contains('open')?'â€¹':'â€º';
})}
if(edgeBtn){edgeBtn.addEventListener('click',()=>{
  sidebar.classList.toggle('open');
  const isMobile=window.innerWidth<=1024;
  if(mask) mask.classList.toggle('show', isMobile && sidebar.classList.contains('open'));
  if(!sidebar.classList.contains('open') && mask) mask.classList.remove('show');
  edgeBtn.textContent=sidebar.classList.contains('open')?'â€¹':'â€º';
})}
if(resizer){resizer.addEventListener('mousedown',e=>{const isMobile=window.innerWidth<=1024;if(isMobile)return;resizeStartX=e.clientX;resizeStartWidth=sidebar.getBoundingClientRect().width;document.body.style.cursor='col-resize';document.body.classList.add('resizing');onResizeMove=ev=>{const dx=ev.clientX-resizeStartX;let w=resizeStartWidth+dx;if(w<160)w=160;if(w>560)w=560;setSidebarWidth(w)};onResizeUp=()=>{document.body.style.cursor='';document.body.classList.remove('resizing');window.removeEventListener('mousemove',onResizeMove);window.removeEventListener('mouseup',onResizeUp)};window.addEventListener('mousemove',onResizeMove);window.addEventListener('mouseup',onResizeUp)})}
if(effectSelect){effectSelect.addEventListener('change',e=>{setEffect(e.target.value)})}
const applyBtnTheme=v=>{const map={sakura:['#ff66c4','#7cf5ff'],mint:['#00dc82','#00b3ff'],sunset:['#ff7a59','#ffd36d'],aurora:['#8a7cff','#2ee5ff'],candy:['#ff9bd6','#9dfbff']};const [accent,accent2]=(map[v]||map.sakura);document.documentElement.style.setProperty('--accent',accent);document.documentElement.style.setProperty('--accent2',accent2);try{localStorage.setItem('btnThemeVariant',v)}catch(err){}};document.addEventListener('DOMContentLoaded',()=>{const v=localStorage.getItem('btnThemeVariant')||((btnThemeSelect&&btnThemeSelect.value)||'sakura');applyBtnTheme(v);if(btnThemeSelect){btnThemeSelect.value=v;btnThemeSelect.addEventListener('change',e=>applyBtnTheme(e.target.value))}});
if(musicBtn&&musicPop){const getItems=()=>[...musicPop.querySelectorAll('.music-item')];const ensureAudio=()=>{if(!bgAudio){bgAudio=new Audio();bgAudio.loop=false;bgAudio.preload='auto';bgAudio.playbackRate=1.15;bgAudio.volume=volSlider?((parseInt(volSlider.value)||60)/100):0.6;bgAudio.addEventListener('play',()=>{musicBtn.classList.add('playing');const p=qs('.mc-play');if(p)p.textContent='â¸'});bgAudio.addEventListener('pause',()=>{musicBtn.classList.remove('playing');const p=qs('.mc-play');if(p)p.textContent='â–¶'});bgAudio.addEventListener('timeupdate',()=>{if(progress&&bgAudio.duration){progress.value=String(Math.floor((bgAudio.currentTime/bgAudio.duration)*100))}});bgAudio.addEventListener('loadedmetadata',()=>{if(progress){progress.value='0'}});bgAudio.addEventListener('ended',()=>{if(progress)progress.value='0';if(playMode==='loop'){buildPlaylist();if(!playlist.length)return;playlistIndex=(playlistIndex+1)%playlist.length;bgAudio.src=playlist[playlistIndex].src;bgAudio.play()}else if(playMode==='shuffle'){buildPlaylist();if(!playlist.length)return;playlistIndex=Math.floor(Math.random()*playlist.length);bgAudio.src=playlist[playlistIndex].src;bgAudio.play()}else{}})}};const loadMusicList=async()=>{try{const res=await fetch('../assets/music/',{cache:'no-store'});if(!res.ok)return[];const html=await res.text();const d=document.createElement('div');d.innerHTML=html;const links=[...d.querySelectorAll('a')].map(a=>a.getAttribute('href')).filter(h=>h&&/\.(mp3|ogg|wav)$/i.test(h));return links.map(h=>{const name=decodeURIComponent(h).split('/').pop().replace(/\.[^/.]+$/,'');let src=h;if(!/^(https?:|\/)/.test(src))src='../assets/music/'+src;return{name,src}})}catch(e){return[]}};const ensureMusicList=async()=>{if(musicLoaded)return;const list=await loadMusicList();if(list.length){musicPop.querySelectorAll('.music-item').forEach(x=>x.remove());list.forEach(it=>{const b=document.createElement('button');b.className='music-item';b.textContent=it.name;b.setAttribute('data-src',it.src);musicPop.appendChild(b)})}musicLoaded=true};musicBtn.addEventListener('click',async()=>{await ensureMusicList();musicPop.classList.toggle('show')});const buildPlaylist=()=>{playlist=getItems().map(it=>({src:it.getAttribute('data-src'),node:it}))};const startPlaylist=(from=0)=>{ensureAudio();buildPlaylist();if(!playlist.length)return;playlistMode=true;playlistIndex=from;getItems().forEach(x=>x.classList.remove('active'));bgAudio.loop=false;bgAudio.src=playlist[playlistIndex].src;bgAudio.play()};getItems().forEach((it,idx)=>{it.addEventListener('click',()=>{ensureAudio();getItems().forEach(x=>x.classList.remove('active'));it.classList.add('active');const src=it.getAttribute('data-src');if(playMode==='single'){playlistMode=false;bgAudio.loop=true;bgAudio.src=src;bgAudio.play()}else{buildPlaylist();playlistMode=true;playlistIndex=idx;bgAudio.loop=false;bgAudio.src=src;bgAudio.play()}musicPop.classList.remove('show')})});if(playBtn){playBtn.addEventListener('click',async()=>{ensureAudio();if(bgAudio.src){if(bgAudio.paused){bgAudio.play()}else{bgAudio.pause()}}else{await ensureMusicList();if(getItems().length){startPlaylist(0)}}})}const setModeUI=()=>{[modeLoopBtn,modeOneBtn,modeShuffleBtn].forEach(b=>b&&b.classList.remove('active'));if(playMode==='loop'){modeLoopBtn&&modeLoopBtn.classList.add('active');bgAudio&&(bgAudio.loop=false)}else if(playMode==='shuffle'){modeShuffleBtn&&modeShuffleBtn.classList.add('active');bgAudio&&(bgAudio.loop=false)}else{modeOneBtn&&modeOneBtn.classList.add('active');bgAudio&&(bgAudio.loop=true)}};if(modeLoopBtn&&modeOneBtn&&modeShuffleBtn){setModeUI();modeLoopBtn.addEventListener('click',()=>{playMode='loop';setModeUI()});modeOneBtn.addEventListener('click',()=>{playMode='single';setModeUI()});modeShuffleBtn.addEventListener('click',()=>{playMode='shuffle';setModeUI()})}if(progress){progress.addEventListener('input',()=>{ensureAudio();if(bgAudio.duration){const v=parseInt(progress.value)||0;bgAudio.currentTime=bgAudio.duration*(v/100)}})}if(prevBtn){prevBtn.addEventListener('click',()=>{ensureAudio();buildPlaylist();if(!playlist.length)return;if(playMode==='shuffle'){playlistIndex=Math.floor(Math.random()*playlist.length)}else{playlistIndex=(playlistIndex-1+playlist.length)%playlist.length}bgAudio.loop=false;bgAudio.src=playlist[playlistIndex].src;bgAudio.play()})}if(nextBtn){nextBtn.addEventListener('click',()=>{ensureAudio();buildPlaylist();if(!playlist.length)return;if(playMode==='shuffle'){playlistIndex=Math.floor(Math.random()*playlist.length)}else{playlistIndex=(playlistIndex+1)%playlist.length}bgAudio.loop=false;bgAudio.src=playlist[playlistIndex].src;bgAudio.play()})}if(volBtn){volBtn.addEventListener('click',()=>{const wrap=qs('.music-wrap');if(wrap)wrap.classList.add('open');if(volPop)volPop.classList.toggle('show')})}if(volSlider){volSlider.addEventListener('input',()=>{ensureAudio();const val=parseInt(volSlider.value)||60;bgAudio.volume=(val/100);if(volText)volText.textContent=`${val}%`})}if(collapseBtn){collapseBtn.addEventListener('click',()=>{const wrap=qs('.music-wrap');const vpop=qs('.mc-volume-pop');if(musicPop)musicPop.classList.remove('show');if(vpop)vpop.classList.remove('show');if(wrap)wrap.classList.remove('open')})}}
if(musicCollapseBtn){musicCollapseBtn.addEventListener('click',()=>{const wrap=qs('.music-wrap');const vpop=qs('.mc-volume-pop');if(musicPop)musicPop.classList.remove('show');if(vpop)vpop.classList.remove('show');if(wrap)wrap.classList.remove('open')})}
const muteBtn=qs('.mc-mute');if(muteBtn){muteBtn.addEventListener('click',()=>{const on=muteBtn.classList.toggle('active');muteBtn.setAttribute('aria-pressed',on?'true':'false')})}
let pausedByBlur=false;
window.addEventListener('blur',()=>{if(muteBtn&&muteBtn.classList.contains('active')&&bgAudio&&!bgAudio.paused){bgAudio.pause();pausedByBlur=true}});
window.addEventListener('focus',()=>{if(muteBtn&&muteBtn.classList.contains('active')&&bgAudio&&pausedByBlur){pausedByBlur=false;bgAudio.play()}});
loadConfig();
enableGradient();
enableStarTrail();
enableClickRipple();
setCardHover('lift')
 if(edgeBtn) edgeBtn.textContent=sidebar.classList.contains('open')?'â€¹':'â€º';
document.addEventListener('click',e=>{const wrap=qs('.music-wrap');if(musicPop&&musicPop.classList.contains('show')&&wrap&&!wrap.contains(e.target)){musicPop.classList.remove('show');wrap.classList.remove('open')}const vpop=qs('.mc-volume-pop');if(vpop&&wrap&&!wrap.contains(e.target)){vpop.classList.remove('show');wrap.classList.remove('open')}});
document.addEventListener('keydown',e=>{if(e.key==='Escape'&&musicPop&&musicPop.classList.contains('show')){musicPop.classList.remove('show');const wrap=qs('.music-wrap');if(wrap)wrap.classList.remove('open');}});
document.addEventListener('click',e=>{if(!musicPop)return;const it=e.target.closest('#music-pop .music-item');if(!it)return;if(!bgAudio){bgAudio=new Audio();bgAudio.loop=false;bgAudio.preload='auto';bgAudio.volume=0.6;bgAudio.addEventListener('play',()=>{musicBtn.classList.add('playing');const p=qs('.mc-play');if(p)p.textContent='â¸'});bgAudio.addEventListener('pause',()=>{musicBtn.classList.remove('playing');const p=qs('.mc-play');if(p)p.textContent='â–¶'})}musicPop.querySelectorAll('.music-item').forEach(x=>x.classList.remove('active'));it.classList.add('active');bgAudio.loop=playMode==='single';bgAudio.src=it.getAttribute('data-src');bgAudio.play();musicPop.classList.add('show');const wrap2=qs('.music-wrap');if(wrap2)wrap2.classList.add('open')});

const modeBtn=qs('.mc-mode');
const markActiveBySrc=src=>{const abs=new URL(src,location.href).href;document.querySelectorAll('#music-pop .music-item').forEach(it=>{const s=new URL(it.getAttribute('data-src'),location.href).href;it.classList.toggle('active',s===abs)})};
const ensureAudio=()=>{if(!bgAudio){bgAudio=new Audio();bgAudio.loop=false;bgAudio.preload='auto';bgAudio.playbackRate=1.15;bgAudio.volume=volSlider?((parseInt(volSlider.value)||60)/100):0.6;bgAudio.addEventListener('play',()=>{musicBtn.classList.add('playing');const p=qs('.mc-play');if(p)p.textContent='â¸'});bgAudio.addEventListener('pause',()=>{musicBtn.classList.remove('playing');const p=qs('.mc-play');if(p)p.textContent='â–¶'});bgAudio.addEventListener('timeupdate',()=>{if(progress&&bgAudio.duration){progress.value=String(Math.floor((bgAudio.currentTime/bgAudio.duration)*100))}});bgAudio.addEventListener('loadedmetadata',()=>{if(progress){progress.value='0'}})}};
let progressRAF=null;
const __bindAudioPlay=()=>{if(bgAudio&&!bgAudio.__bindPlay){bgAudio.__bindPlay=true;const startProgress=()=>{if(progressRAF){cancelAnimationFrame(progressRAF);progressRAF=null}const loop=()=>{if(progress&&bgAudio&&!bgAudio.paused&&bgAudio.duration){progress.value=String(Math.floor((bgAudio.currentTime/bgAudio.duration)*100))}if(bgAudio&&!bgAudio.paused){progressRAF=requestAnimationFrame(loop)}else{progressRAF=null}};loop()};const stopProgress=()=>{if(progressRAF){cancelAnimationFrame(progressRAF);progressRAF=null}};bgAudio.addEventListener('play',()=>{startProgress();markActiveBySrc(bgAudio.src)});bgAudio.addEventListener('pause',stopProgress);bgAudio.addEventListener('ended',()=>{stopProgress();if(progress)progress.value='0'})}};setInterval(__bindAudioPlay,500);
const updateModeUI=()=>{
  if(!modeBtn) return;
  if(playMode==='loop'){
    modeBtn.textContent='ðŸ”'
    modeBtn.classList.remove('mode-one')
  } else if(playMode==='shuffle'){
    modeBtn.textContent='ðŸ”€'
    modeBtn.classList.remove('mode-one')
  } else {
    modeBtn.textContent='1ï¸âƒ£'
    modeBtn.classList.remove('mode-one')
  }
  if(bgAudio) bgAudio.loop = (playMode==='single')
};
updateModeUI();
if(modeBtn){modeBtn.addEventListener('click',()=>{if(playMode==='loop')playMode='shuffle';else if(playMode==='shuffle')playMode='single';else playMode='loop';updateModeUI()})}

const getMusicItems=()=>[...document.querySelectorAll('#music-pop .music-item')];
const srcAbs=s=>new URL(s,location.href).href;
const indexBySrc=s=>{const items=getMusicItems();const a=srcAbs(s||'');return items.findIndex(it=>srcAbs(it.getAttribute('data-src'))===a)};
const switchToSrc=src=>{ensureAudio();bgAudio.pause();bgAudio.currentTime=0;bgAudio.src=src;markActiveBySrc(bgAudio.src);const onReady=()=>{bgAudio.play().catch(()=>{});bgAudio.removeEventListener('canplay',onReady)};bgAudio.addEventListener('canplay',onReady);bgAudio.load()};
const ensureShuffleOrder=startIdx=>{const items=getMusicItems();if(!items.length)return;let rest=items.map((_,i)=>i).filter(i=>i!==startIdx);for(let i=rest.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[rest[i],rest[j]]=[rest[j],rest[i]]}window.__shuffleOrder=[startIdx,...rest];window.__shuffleCursor=0};
const nextFromShuffle=()=>{const items=getMusicItems();if(!items.length||playMode!=='shuffle')return null;const cur=indexBySrc(bgAudio?bgAudio.src:'');if(!Array.isArray(window.__shuffleOrder)||window.__shuffleOrder.length!==items.length){ensureShuffleOrder(cur>=0?cur:0)}if(typeof window.__shuffleCursor!=='number')window.__shuffleCursor=0;let nxtIdx=window.__shuffleOrder[window.__shuffleCursor+1];if(nxtIdx===undefined){ensureShuffleOrder(cur>=0?cur:0);nxtIdx=window.__shuffleOrder[window.__shuffleCursor+1]}window.__shuffleCursor++;return items[nxtIdx]?items[nxtIdx].getAttribute('data-src'):null};
const prevFromShuffle=()=>{const items=getMusicItems();if(!items.length||playMode!=='shuffle')return null;if(!Array.isArray(window.__shuffleOrder)||window.__shuffleOrder.length!==items.length){const cur=indexBySrc(bgAudio?bgAudio.src:'');ensureShuffleOrder(cur>=0?cur:0)}if(typeof window.__shuffleCursor!=='number')window.__shuffleCursor=0;if(window.__shuffleCursor<=0){window.__shuffleCursor=window.__shuffleOrder.length-1}else{window.__shuffleCursor-=1}const prevIdx=window.__shuffleOrder[window.__shuffleCursor];return items[prevIdx]?items[prevIdx].getAttribute('data-src'):null};

if(playBtn){playBtn.addEventListener('click',()=>{setTimeout(()=>{if(bgAudio&&bgAudio.src){markActiveBySrc(bgAudio.src)}},0)})}
if(nextBtn){nextBtn.addEventListener('click',(e)=>{e.stopImmediatePropagation();const items=getMusicItems();if(!items.length)return;let src=null;if(playMode==='shuffle'){src=nextFromShuffle();if(!src){const cur=indexBySrc(bgAudio?bgAudio.src:'');ensureShuffleOrder(cur>=0?cur:0);src=nextFromShuffle()}}else{const cur=indexBySrc(bgAudio?bgAudio.src:'');const next=(cur>=0?((cur+1)%items.length):0);src=items[next].getAttribute('data-src')}switchToSrc(src)},true)}
if(prevBtn){prevBtn.addEventListener('click',(e)=>{e.stopImmediatePropagation();const items=getMusicItems();if(!items.length)return;let src=null;if(playMode==='shuffle'){src=prevFromShuffle();if(!src){const cur=indexBySrc(bgAudio?bgAudio.src:'');ensureShuffleOrder(cur>=0?cur:0);src=prevFromShuffle()}}else{const cur=indexBySrc(bgAudio?bgAudio.src:'');const prev=(cur>=0?((cur-1+items.length)%items.length):0);src=items[prev].getAttribute('data-src')}switchToSrc(src)},true)}
const __bindAudioEnded=()=>{if(bgAudio&&!bgAudio.__bindEnded){bgAudio.__bindEnded=true;bgAudio.addEventListener('ended',()=>{if(playMode==='shuffle'){const src=nextFromShuffle();if(src){bgAudio.pause();bgAudio.currentTime=0;bgAudio.src=src;markActiveBySrc(bgAudio.src);bgAudio.load();bgAudio.play().catch(()=>{})}}})}};setInterval(()=>{__bindAudioPlay();__bindAudioEnded()},500)
};

document.addEventListener('DOMContentLoaded',init);
document.addEventListener('DOMContentLoaded',()=>{const musicPop=qs('#music-pop');const coverBox=qs('.music-cover');if(!musicPop||!coverBox)return;musicPop.addEventListener('mouseover',e=>{const it=e.target.closest('#music-pop .music-item');if(!it)coverBox.classList.remove('show')})});
document.addEventListener('DOMContentLoaded',()=>{const grid=qs('.grid');if(!grid)return;const ensureGap=()=>{const cs=getComputedStyle(grid);const g=parseFloat(cs.gap)||0;if(g<gridCfg.gapPx)grid.style.setProperty('--grid-gap',`${gridCfg.gapPx}px`)};const adjust=()=>{ensureGap();const cs=getComputedStyle(grid);const width=grid.clientWidth;const gap=parseFloat(cs.gap)||gridCfg.gapPx;let cols=parseInt(cs.getPropertyValue('--grid-cols'))||4;const minRatio=gridCfg.minRatio;const maxRatio=gridCfg.maxRatio;let tries=0;while(tries<12){const cardW=(width-(cols-1)*gap)/cols;const ratio=gap/cardW;if(ratio>maxRatio){if(cols>gridCfg.minCols)cols--;else break}else if(ratio<minRatio){if(cols<gridCfg.maxCols)cols++;else break}else{break}tries++}grid.style.setProperty('--grid-cols',String(Math.max(gridCfg.minCols,Math.min(gridCfg.maxCols,cols))))};adjust();window.addEventListener('resize',adjust)});
document.addEventListener('DOMContentLoaded',()=>{const grid=qs('.grid');const prev=qs('.page-prev');const next=qs('.page-next');const sizeSel=qs('.page-size');const pageSel=qs('.page-select');const info=qs('.page-info');const totalText=qs('.page-total');if(!grid||!prev||!next||!sizeSel||!pageSel||!info||!totalText)return;const getCards=()=>[...grid.querySelectorAll('.card')];let pageSize=parseInt(sizeSel.value)||12;let total=1;let current=1;const updateTotals=()=>{const count=getCards().length;total=Math.max(1,Math.ceil(count/pageSize));if(current>total)current=total};const renderSelect=()=>{pageSel.innerHTML='';for(let i=1;i<=total;i++){const o=document.createElement('option');o.value=String(i);o.textContent=String(i);pageSel.appendChild(o)}pageSel.value=String(current);totalText.textContent=`/ å…± ${total} é¡µ`};const renderPage=()=>{const cards=getCards();updateTotals();const start=(current-1)*pageSize;const end=start+pageSize;cards.forEach((c,i)=>{c.style.display=(i>=start&&i<end)?'':'none'});renderSelect()};renderPage();prev.addEventListener('click',()=>{if(current>1){current--;renderPage()}});next.addEventListener('click',()=>{if(current<total){current++;renderPage()}});sizeSel.addEventListener('change',()=>{pageSize=parseInt(sizeSel.value)||12;current=1;renderPage()});pageSel.addEventListener('change',()=>{current=parseInt(pageSel.value)||1;if(current<1)current=1;if(current>total)current=total;renderPage()});const mo=new MutationObserver(()=>{renderPage()});mo.observe(grid,{childList:true,subtree:false})});
document.addEventListener('DOMContentLoaded',()=>{const musicBtn=qs('.music-btn');const musicPop=qs('#music-pop');if(!musicBtn||!musicPop)return;const coverBox=document.createElement('div');coverBox.className='music-cover';const coverImg=document.createElement('img');coverBox.appendChild(coverImg);const wrap=qs('.music-wrap');if(wrap)wrap.appendChild(coverBox);const coverCache=new Map();const ensureMetaLib=async()=>{await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js')};const getCover=async(src)=>{if(coverCache.has(src))return coverCache.get(src);try{await ensureMetaLib();const abs=new URL(src,location.href).href;return await new Promise((resolve)=>{new window.jsmediatags.Reader(abs).setTagsToRead(['picture']).read({onSuccess:t=>{const p=t.tags&&t.tags.picture;if(!p){resolve(null);return}let s='';const d=p.data;for(let i=0;i<d.length;i++)s+=String.fromCharCode(d[i]);const url=`data:${p.format};base64,${btoa(s)}`;coverCache.set(src,url);resolve(url)},onError:()=>resolve(null)})})}catch(e){return null}};let coverToken=0;let coverAllowed=false;let hoverTimer=null;const showCoverFor=async(src,token)=>{const url=await getCover(src);if(!coverAllowed||token!==coverToken)return;if(url){coverImg.src=url;coverBox.classList.add('show')}else{coverBox.classList.remove('show')}};musicPop.addEventListener('mouseover',e=>{const it=e.target.closest('#music-pop .music-item');if(!it){coverBox.classList.remove('show');return}const src=it.getAttribute('data-src');if(!src)return;coverAllowed=true;const t=++coverToken;if(hoverTimer)clearTimeout(hoverTimer);hoverTimer=setTimeout(()=>{showCoverFor(src,t)},150)});musicPop.addEventListener('mouseleave',()=>{coverAllowed=false;coverToken++;coverBox.classList.remove('show')});['.mc-play','.mc-prev','.mc-next','.mc-mode','.mc-volume','.music-btn'].forEach(sel=>{const el=qs(sel);if(!el)return;const hide=()=>{coverAllowed=false;coverToken++;coverBox.classList.remove('show')};el.addEventListener('mouseenter',hide);el.addEventListener('focus',hide)});
  const mo=new MutationObserver(()=>{const wrap=qs('.music-wrap');const open=musicPop.classList.contains('show');if(!open)coverBox.classList.remove('show');if(wrap)wrap.classList.toggle('open',open)});mo.observe(musicPop,{attributes:true,attributeFilter:['class']});
  ['.mc-play','.mc-prev','.mc-next','.mc-mode','.mc-volume','.music-btn'].forEach(sel=>{const el=qs(sel);if(!el)return;const hide=()=>coverBox.classList.remove('show');el.addEventListener('mouseenter',hide);el.addEventListener('focus',hide)});
  window.addEventListener('blur',()=>{coverBox.classList.remove('show')});
});
document.addEventListener('DOMContentLoaded',()=>{const btn=qs('.guide-toggle');if(!btn)return;});
document.addEventListener('DOMContentLoaded',()=>{const btn=qs('.guide-toggle');const hero=qs('#hero-cover');const vid=qs('#hero-video');const exitBtn=qs('#cover-exit');const sidebar=qs('.sidebar');const edgeBtn=qs('.sidebar-edge');if(!btn||!hero||!vid)return;let prevOpen=false;const enter=()=>{prevOpen=sidebar?sidebar.classList.contains('open'):false;document.body.classList.add('cover-mode');vid.muted=true;try{const url=new URL(vid.getAttribute('src'),location.href).href;vid.src=url;vid.load();vid.play().catch(()=>{});}catch(e){vid.play().catch(()=>{})}};const leave=()=>{document.body.classList.remove('cover-mode');vid.pause();if(sidebar){if(prevOpen)sidebar.classList.add('open');else sidebar.classList.remove('open');}if(edgeBtn)edgeBtn.textContent=sidebar&&sidebar.classList.contains('open')?'â€¹':'â€º';};btn.addEventListener('click',()=>{if(document.body.classList.contains('cover-mode'))leave();else enter()});if(exitBtn)exitBtn.addEventListener('click',leave)});
document.addEventListener('DOMContentLoaded',()=>{const grid=qs('.grid');if(!grid)return;const count=100;for(let i=0;i<count;i++){const art=document.createElement('article');art.className='card';const banner=document.createElement('div');banner.className='card-banner';const body=document.createElement('div');body.className='card-body';art.appendChild(banner);art.appendChild(body);grid.appendChild(art)}});
document.addEventListener('DOMContentLoaded',()=>{const wrap=qs('.avatar-wrap');const pop=qs('#avatar-pop');if(!wrap||!pop)return;let t=null;const show=()=>{if(t){clearTimeout(t);t=null}pop.classList.add('show')};const schedule=()=>{if(t)clearTimeout(t);t=setTimeout(()=>{const hovered=wrap.matches(':hover')||pop.matches(':hover');if(!hovered)pop.classList.remove('show')},120)};wrap.addEventListener('mouseenter',show);pop.addEventListener('mouseenter',show);wrap.addEventListener('mouseleave',schedule);pop.addEventListener('mouseleave',schedule);document.addEventListener('click',e=>{if(pop.classList.contains('show')&&!wrap.contains(e.target))pop.classList.remove('show')})});
const enableTrail=()=>{if(trailCanvas)return;trailCanvas=document.createElement('canvas');trailCanvas.className='bg-trail';trailCanvas.style.cssText='position:fixed;left:0;top:0;width:100%;height:100%;z-index:-1;pointer-events:none';document.body.appendChild(trailCanvas);trailCtx=trailCanvas.getContext('2d');resizeTrail=()=>{trailCanvas.width=window.innerWidth;trailCanvas.height=window.innerHeight};resizeTrail();window.addEventListener('resize',resizeTrail);const particles=[];onMoveTrail=e=>{const rect={x:e.clientX,y:e.clientY};for(let i=0;i<6;i++){particles.push({x:rect.x+(Math.random()-0.5)*6,y:rect.y+(Math.random()-0.5)*6,r:3+Math.random()*4,alpha:1,life:1,h:Math.random()*360})}};window.addEventListener('mousemove',onMoveTrail);const draw=()=>{trailCtx.clearRect(0,0,trailCanvas.width,trailCanvas.height);for(const p of particles){p.alpha*=0.94;p.r*=0.98;p.y-=0.3;if(p.alpha<0.02||p.r<0.8){const idx=particles.indexOf(p);if(idx>-1)particles.splice(idx,1);continue}trailCtx.beginPath();trailCtx.arc(p.x,p.y,p.r,0,Math.PI*2);trailCtx.fillStyle=`hsla(${p.h},90%,70%,${p.alpha})`;trailCtx.fill()}trailTimer=requestAnimationFrame(draw)};draw()};
const disableTrail=()=>{if(trailTimer)cancelAnimationFrame(trailTimer);trailTimer=null;if(onMoveTrail)window.removeEventListener('mousemove',onMoveTrail);onMoveTrail=null;if(resizeTrail)window.removeEventListener('resize',resizeTrail);resizeTrail=null;if(trailCanvas){trailCanvas.remove();trailCanvas=null;trailCtx=null}};
const enableStarTrail=()=>{if(starCanvas)return;starCanvas=document.createElement('canvas');starCanvas.className='bg-startrail';starCanvas.style.cssText=`position:fixed;left:0;top:0;width:100%;height:100%;z-index:${starCfg.zIndex};pointer-events:none`;document.body.appendChild(starCanvas);starCtx=starCanvas.getContext('2d');resizeStar=()=>{starCanvas.width=window.innerWidth;starCanvas.height=window.innerHeight};resizeStar();window.addEventListener('resize',resizeStar);const stars=[];const drawStar=(ctx,x,y,r,rot)=>{ctx.save();ctx.translate(x,y);ctx.rotate(rot);ctx.beginPath();const spikes=5;const step=Math.PI/spikes;let angle=-Math.PI/2;for(let i=0;i<spikes;i++){ctx.lineTo(Math.cos(angle)*r,Math.sin(angle)*r);angle+=step;ctx.lineTo(Math.cos(angle)*r*0.5,Math.sin(angle)*r*0.5);angle+=step}ctx.closePath();ctx.fill();ctx.restore()};onMoveStar=e=>{const now=Date.now();if(now-starLastAt<starCfg.spawnIntervalMs)return;starLastAt=now;for(let i=0;i<starCfg.spawnCount;i++){stars.push({x:e.clientX+(Math.random()-0.5)*6,y:e.clientY+(Math.random()-0.5)*6,vx:(Math.random()-0.5)*starCfg.velocityRange,vy:(Math.random()-0.5)*starCfg.velocityRange,r:starCfg.radiusMin+Math.random()*(starCfg.radiusMax-starCfg.radiusMin),rot:Math.random()*Math.PI,vr:(Math.random()-0.5)*0.08,alpha:starCfg.initialAlpha,h:40+Math.random()*280})}};window.addEventListener('mousemove',onMoveStar);const draw=()=>{starCtx.clearRect(0,0,starCanvas.width,starCanvas.height);for(const s of stars){s.x+=s.vx;s.y+=s.vy;s.vy-=0.01;s.alpha*=starCfg.alphaDecay;s.r*=starCfg.radiusDecay;s.rot+=s.vr;if(s.alpha<starCfg.minAlphaThreshold||s.r<starCfg.minRadiusThreshold){const idx=stars.indexOf(s);if(idx>-1)stars.splice(idx,1);continue}starCtx.fillStyle=`hsla(${s.h},90%,70%,${s.alpha})`;drawStar(starCtx,s.x,s.y,s.r,s.rot)}starTimer=requestAnimationFrame(draw)};draw()};
const disableStarTrail=()=>{if(starTimer)cancelAnimationFrame(starTimer);starTimer=null;if(onMoveStar)window.removeEventListener('mousemove',onMoveStar);onMoveStar=null;if(resizeStar)window.removeEventListener('resize',resizeStar);resizeStar=null;if(starCanvas){starCanvas.remove();starCanvas=null;starCtx=null}};
const enableClickRipple=()=>{if(rippleCanvas)return;rippleCanvas=document.createElement('canvas');rippleCanvas.className='bg-click-ripple';rippleCanvas.style.cssText=`position:fixed;left:0;top:0;width:100%;height:100%;z-index:${rippleCfg.zIndex};pointer-events:none`;document.body.appendChild(rippleCanvas);rippleCtx=rippleCanvas.getContext('2d');resizeRipple=()=>{rippleCanvas.width=window.innerWidth;rippleCanvas.height=window.innerHeight};resizeRipple();window.addEventListener('resize',resizeRipple);const ripples=[];onClickRipple=e=>{ripples.push({x:e.clientX,y:e.clientY,r:0,max:rippleCfg.maxRadius,w:rippleCfg.lineWidth,alpha:rippleCfg.alphaStart,h:Math.random()*360})};window.addEventListener('click',onClickRipple);const draw=()=>{rippleCtx.clearRect(0,0,rippleCanvas.width,rippleCanvas.height);for(const rp of ripples){rp.r+=rippleCfg.growSpeed;rippleCtx.beginPath();rippleCtx.arc(rp.x,rp.y,rp.r,0,Math.PI*2);rippleCtx.lineWidth=rp.w;rippleCtx.strokeStyle=`hsla(${rp.h},90%,65%,${rp.alpha})`;rippleCtx.stroke();rp.alpha*=rippleCfg.alphaDecay;rp.w*=rippleCfg.lineWidthDecay;if(rp.r>rp.max||rp.alpha<0.03){const idx=ripples.indexOf(rp);if(idx>-1)ripples.splice(idx,1)}}rippleTimer=requestAnimationFrame(draw)};draw()};
const enableClickBurst=()=>{if(burstCanvas)return;burstCanvas=document.createElement('canvas');burstCanvas.className='bg-click-burst';burstCanvas.style.cssText='position:fixed;left:0;top:0;width:100%;height:100%;z-index:9999;pointer-events:none';document.body.appendChild(burstCanvas);burstCtx=burstCanvas.getContext('2d');resizeBurst=()=>{burstCanvas.width=window.innerWidth;burstCanvas.height=window.innerHeight};resizeBurst();window.addEventListener('resize',resizeBurst);const parts=[];onClickBurst=e=>{for(let i=0;i<26;i++){const a=Math.random()*Math.PI*2;const s=2+Math.random()*4;parts.push({x:e.clientX,y:e.clientY,vx:Math.cos(a)*s,vy:Math.sin(a)*s,alpha:1,r:2+Math.random()*3,h:Math.random()*360})}};window.addEventListener('click',onClickBurst);const draw=()=>{burstCtx.clearRect(0,0,burstCanvas.width,burstCanvas.height);for(const p of parts){p.x+=p.vx;p.y+=p.vy;p.alpha*=0.96;p.r*=0.98;p.vy+=0.04;if(p.alpha<0.03){const idx=parts.indexOf(p);if(idx>-1)parts.splice(idx,1);continue}burstCtx.beginPath();burstCtx.arc(p.x,p.y,p.r,0,Math.PI*2);burstCtx.fillStyle=`hsla(${p.h},90%,70%,${p.alpha})`;burstCtx.fill()}burstTimer=requestAnimationFrame(draw)};draw()};
const disableClickRipple=()=>{if(rippleTimer)cancelAnimationFrame(rippleTimer);rippleTimer=null;if(onClickRipple)window.removeEventListener('click',onClickRipple);onClickRipple=null;if(resizeRipple)window.removeEventListener('resize',resizeRipple);resizeRipple=null;if(rippleCanvas){rippleCanvas.remove();rippleCanvas=null;rippleCtx=null}};
const disableClickBurst=()=>{if(burstTimer)cancelAnimationFrame(burstTimer);burstTimer=null;if(onClickBurst)window.removeEventListener('click',onClickBurst);onClickBurst=null;if(resizeBurst)window.removeEventListener('resize',resizeBurst);resizeBurst=null;if(burstCanvas){burstCanvas.remove();burstCanvas=null;burstCtx=null}};
document.addEventListener('DOMContentLoaded',()=>{const pop=qs('#music-pop');if(!pop)return;const startScroll=btn=>{if(!btn||!btn.classList.contains('music-item'))return;let label=btn.querySelector('.scroll-text');if(!label){label=document.createElement('span');label.className='scroll-text';label.textContent=btn.textContent;btn.textContent='';btn.appendChild(label)}label.style.display='inline-block';const cs=getComputedStyle(btn);const pl=parseFloat(cs.paddingLeft)||0;const pr=parseFloat(cs.paddingRight)||0;const viewW=btn.clientWidth - pl - pr;const distance=label.scrollWidth - viewW; if(distance>2){btn.style.setProperty('--scroll-distance',`${distance}px`);const speed=120;const dur=Math.max(1.2,distance/speed);btn.style.setProperty('--scroll-duration',`${dur}s`);if(btn._mqTimer){clearTimeout(btn._mqTimer);btn._mqTimer=null}if(label._mqEnd){label.removeEventListener('animationend',label._mqEnd);label._mqEnd=null}btn.classList.add('scrolling');label._mqEnd=()=>{btn._mqTimer=setTimeout(()=>{btn.classList.remove('scrolling');label.style.transform='translateX(0)';void label.offsetWidth;btn.classList.add('scrolling')},1000)};label.addEventListener('animationend',label._mqEnd)}else{btn.classList.remove('scrolling');btn.style.removeProperty('--scroll-distance');btn.style.removeProperty('--scroll-duration');label.style.transform='translateX(0)'}};const stopScroll=btn=>{if(!btn)return;if(btn._mqTimer){clearTimeout(btn._mqTimer);btn._mqTimer=null}const label=btn.querySelector('.scroll-text');if(label&&label._mqEnd){label.removeEventListener('animationend',label._mqEnd);label._mqEnd=null}btn.classList.remove('scrolling');btn.style.removeProperty('--scroll-distance');btn.style.removeProperty('--scroll-duration');if(label)label.style.transform='translateX(0)'};pop.addEventListener('mouseover',e=>{const it=e.target.closest('#music-pop .music-item');if(it){startScroll(it)}else{const ctrl=e.target.closest('#music-pop .music-stop, #music-pop .music-loop');if(ctrl){const cur=pop.querySelector('.music-item.scrolling');stopScroll(cur)}}});pop.addEventListener('mouseleave',()=>{const cur=pop.querySelector('.music-item.scrolling');stopScroll(cur)})});
document.addEventListener('DOMContentLoaded',()=>{const pop=qs('#music-pop');if(!pop)return;pop.addEventListener('mouseover',e=>{const it=e.target.closest('#music-pop .music-item');if(!it)return;const cur=pop.querySelector('.music-item.scrolling');if(cur&&cur!==it){cur.classList.remove('scrolling');cur.style.removeProperty('--scroll-distance');cur.style.removeProperty('--scroll-duration');const label=cur.querySelector('.scroll-text');if(label)label.style.transform='translateX(0)'}})});